<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>sizuhiko - Technote</title>
    <link rel="shortcut icon" href="/imgages/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="/stylesheets/main.css" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="/javascripts/socialite.min.js"></script>
    <script type="text/javascript" src="http://www.scribd.com/javascripts/scribd_api.js"></script>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />

    <!--[if lte IE 8]>
      <link rel="stylesheet" href="/stylesheets/browsers/ie.css" type="text/css">
      <script src="/javascripts/browsers/ie8.js"></script>
      <script defer src="/javascripts/browsers/ie-css3.js"></script>
    <![endif]-->
    <!--[if IE 6]>
      <link rel="stylesheet" href="/styleseets/browsers/ie6.css" type="text/css">
    <![endif]-->
    <!--[if IE 7]>
      <link rel="stylesheet" href="/styleseets/browsers/ie7.css" type="text/css">
    <![endif]-->
    <!--[if IE 8]>
      <link rel="stylesheet" href="/stylesheets/browsers/ie8.css" type="text/css">
    <![endif]-->
    <style type="text/css">
      @media all and (max-width:680px) {
        #blogtools a, #blogtools a:link, #blogtools a:visited { position:relative; top:0; margin:0 0 5px 10px; float:left; background:#f1f1f1; color:#111; border:1px solid #888; }
        #postcontent, #posttitle { width:100%; }
        #qppreview { display:none; }
        #qpsubmit { width:auto !important; float:none; line-height:1.4; height:auto; margin:7px 0; }
        #postform b { display:block; }
        #sharing { float:none; padding-top:3px; }
        }
    </style>
    <style type="text/css">
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .cm {
  color: #999988;
  font-style: italic;
}
.highlight .cp {
  color: #999999;
  font-weight: bold;
}
.highlight .c1 {
  color: #999988;
  font-style: italic;
}
.highlight .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #999988;
  font-style: italic;
}
.highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}
.highlight .gd {
  color: #000000;
  background-color: #ffdddd;
}
.highlight .ge {
  color: #000000;
  font-style: italic;
}
.highlight .gr {
  color: #aa0000;
}
.highlight .gh {
  color: #999999;
}
.highlight .gi {
  color: #000000;
  background-color: #ddffdd;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
  font-weight: bold;
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .gt {
  color: #aa0000;
}
.highlight .kc {
  color: #000000;
  font-weight: bold;
}
.highlight .kd {
  color: #000000;
  font-weight: bold;
}
.highlight .kn {
  color: #000000;
  font-weight: bold;
}
.highlight .kp {
  color: #000000;
  font-weight: bold;
}
.highlight .kr {
  color: #000000;
  font-weight: bold;
}
.highlight .kt {
  color: #445588;
  font-weight: bold;
}
.highlight .k, .highlight .kv {
  color: #000000;
  font-weight: bold;
}
.highlight .mf {
  color: #009999;
}
.highlight .mh {
  color: #009999;
}
.highlight .il {
  color: #009999;
}
.highlight .mi {
  color: #009999;
}
.highlight .mo {
  color: #009999;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #009999;
}
.highlight .sa {
  color: #000000;
  font-weight: bold;
}
.highlight .sb {
  color: #d14;
}
.highlight .sc {
  color: #d14;
}
.highlight .sd {
  color: #d14;
}
.highlight .s2 {
  color: #d14;
}
.highlight .se {
  color: #d14;
}
.highlight .sh {
  color: #d14;
}
.highlight .si {
  color: #d14;
}
.highlight .sx {
  color: #d14;
}
.highlight .sr {
  color: #009926;
}
.highlight .s1 {
  color: #d14;
}
.highlight .ss {
  color: #990073;
}
.highlight .s, .highlight .dl {
  color: #d14;
}
.highlight .na {
  color: #008080;
}
.highlight .bp {
  color: #999999;
}
.highlight .nb {
  color: #0086B3;
}
.highlight .nc {
  color: #445588;
  font-weight: bold;
}
.highlight .no {
  color: #008080;
}
.highlight .nd {
  color: #3c5d5d;
  font-weight: bold;
}
.highlight .ni {
  color: #800080;
}
.highlight .ne {
  color: #990000;
  font-weight: bold;
}
.highlight .nf, .highlight .fm {
  color: #990000;
  font-weight: bold;
}
.highlight .nl {
  color: #990000;
  font-weight: bold;
}
.highlight .nn {
  color: #555555;
}
.highlight .nt {
  color: #000080;
}
.highlight .vc {
  color: #008080;
}
.highlight .vg {
  color: #008080;
}
.highlight .vi {
  color: #008080;
}
.highlight .nv, .highlight .vm {
  color: #008080;
}
.highlight .ow {
  color: #000000;
  font-weight: bold;
}
.highlight .o {
  color: #000000;
  font-weight: bold;
}
.highlight .w {
  color: #bbbbbb;
}
.highlight {
  background-color: #f8f8f8;
}
    </style>
    <script type="text/javascript">
      $(document).ready(function() {
        Socialite.load("blog-social");
      });
    </script>

  </head>
  <body id="myopera" data-twttr-rendered="true">
    <!--[if IE 6]><div class="ie6"><![endif]-->
    <!--[if IE 7]><div class="ie7"><![endif]-->
    <!--[if IE 8]><div class="ie8"><![endif]-->
    <!--[if IE 9]><div class="ie9"><![endif]-->
    <div id="wrap0"><div id="wrap1"><div id="wrap2"><div id="wrap3"><div id="wrap4">

    <div id="top" class="top-blog">
      <div id="top2">
        <h1><a href="/" title="home"><span>Technote</span></a></h1>
        <p id="subtitle"><span>by sizuhiko</span></p>
      </div>
    </div>

    <div id="content" class="blogfront">
      <div id="mainwrap">
        <div id="main">

            <h2 class="title"><a href="/2014/09/07/cakephp-ci-book.html">CakePHPで学ぶ継続的インテグレーションが発売されます</a></h2>
  <p class="postdate"><a href="/2014/09/07.html" title="Permanent link">Sunday, September 07, 2014 02:04:00 PM</a></p>
  <p class="tags">
      <a href="/tags/cakephp.html" rel="tag">CakePHP</a>
      <a href="/tags/ci.html" rel="tag">ci</a>
      <a href="/tags/book.html" rel="tag">book</a>
      <a href="/tags/php.html" rel="tag">PHP</a>
  </p>
  <div class="content">
    <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
    <p>先日の記事にも書きましたが、</p>

<blockquote>
<p>春先ぐらいからBlogの更新が滞っていましたが、その要因となったアレが大分落ち着いてきたので、たまっていたネタを順番に書き出します。</p>
</blockquote>

<p><code>アレ</code>が出ます。</p>

<p><img src="/images/blog/cakephp_ci_book.jpg" alt="" /></p>

<p>ババーン ww とでかい画像を付けましたよ。</p>

<h3>CakePHPで学ぶ継続的インテグレーション</h3>

<p>共著者の</p>

<ul>
<li><a href="http://kaz29.hatenablog.com/entry/2014/09/03/095358">@kaz_29さんのブログ</a></li>
<li><a href="http://www.ryuzee.com/contents/blog/6994">@ryuzeeさんのブログ</a></li>
</ul>

<p>でも既に紹介されていますので、そちらを一読いただくと理解が深まります。</p>

<p>私は主に以下のあたりを担当しました。</p>

<ul>
<li>Chapter 5 開発工程(1)

<ul>
<li>5-1 開発の進め方</li>
<li>5-2 ユーザーストーリーの定義</li>
<li>5-3 機能実装</li>
</ul></li>
<li>Chapter 6 開発工程(2)

<ul>
<li>6-1 ステップの定義</li>
<li>6-2 継続的インテグレーションの定義</li>
</ul></li>
</ul>

<p>上記以外でも、おおよそCakePHPに関連するところを書いたと思っていただければ。</p>

<h3>これは何の本</h3>

<p>タイトルの通り、と言いたいところですが、わからないという人のために補足すると</p>

<ul>
<li>継続的インテグレーションの入門書です</li>
<li>CakePHPでのアプリケーションの作り方を解説した本ではありません</li>
<li>サンプルアプリケーションの構築、自動テストの作成方法の解説にCakePHPを使っています</li>
</ul>

<p>タイトルや見出しから内容が想像しずらいと思うので、私が書いた部分の継続的インテグレーションに関する技術的キーワードを列挙すると、以下のとおりです。</p>

<ul>
<li><a href="https://getcomposer.org/">Composer</a></li>
<li><a href="http://docs.behat.org/en/v2.5/">Behat</a></li>
<li>ユニットテスト</li>
<li><a href="https://github.com/CakeDC/migrations">CakePHP Migrations プラグイン</a></li>
<li><a href="https://github.com/josegonzalez/cakephp-environments">CakePHP Environments プラグイン</a></li>
<li><a href="https://github.com/sizuhiko/Bdd">CakePHP BDDプラグイン</a></li>
<li><a href="https://github.com/sizuhiko/Fabricate">CakePHP Fabricate プラグイン</a></li>
</ul>

<p>上記以外にアプリケーション構築用にBoostCake、CakeDC Usersプラグインも使っています。
自分が作ったプラグインであるBDDとFabricateを採用していますが、これは現在支援を行っている現場でも活躍しているので手前味噌というだけでなく、自動テストを継続していく上で役立つと思います。</p>

<p>私の記述したところの、ざっくりした解説は以下のとおりです。</p>

<ul>
<li>ComposerとMigrationsプラグインを使うと、誰でも簡単に同じ環境を構築することができるようになります。</li>
<li>Environmentsプラグインを使うと、環境毎の設定切り替えや、振る舞いの制御を容易にできるようになります。</li>
<li>BDDプラグインを使うとCakePHPからBehatとの連携が容易になり、受入テストの自動化に取り組みやすくなります。</li>
<li>Fabricateプラグインを使うとFixtureを使ったテストデータの呪縛から解放されます。</li>
</ul>

<p>これらは過去から現在に至るまで、私が様々なプロジェクトで経験したことを背景にしています。
もちろんプロジェクトごとに様々な背景があると思いますが、一度実践していただければ効果を体感していただけるのではないかと思っています。</p>

<p>また、PHP界隈ではまだBDDやATDDに関して、解説する本がなかったり、実践的な解説がなかったのですが、本書がこれらを導入するきっかけになると嬉しいなと思っています。</p>

<h3>CakePHP以外ではどうなの</h3>

<p>サンプルアプリケーションの構築にはCakePHPを利用していますが、上記の技術要素に関しては他のPHPフレームワークでも同様のものがあると思います。
もし、CakePHP以外のフレームワークに精通していれば、Behatを直接使ったり、データジェネレータにFakerの機能を使ったり、各フレームワークのマイグレーションや環境切り替えプラグインを使ったりできるのではないかと思います。
皆様の現場の状況に合わせて読み替えて、継続的インテグレーションを導入する参考にしていただければ幸いです。</p>

<h3>いつ発売なの？</h3>

<p><a href="http://www.amazon.co.jp/CakePHP%E3%81%A7%E5%AD%A6%E3%81%B6%E7%B6%99%E7%B6%9A%E7%9A%84%E3%82%A4%E3%83%B3%E3%83%86%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3-%E6%B8%A1%E8%BE%BA-%E4%B8%80%E5%AE%8F/dp/4844336789/ref=la_B004LVAF8Q_1_1?s=books&amp;ie=UTF8&amp;qid=1410066610&amp;sr=1-1">amazon</a>では<code>2014/09/19(金)</code>に発売です。</p>

<p>書店などでは多少前後することがあると思いますが、ぜひ一度手に取ってみてください。</p>

<p>また9/19は、茅場町Co-Edoにて<a href="http://coedo-cakephp.doorkeeper.jp/events/15008">CakeFest2014報告会</a>を実施します。本会には共著者である@kaz_29さんも参加予定なので、著者サインを集めるチャンスです！
先月実施されたCakeFestではどんな事があったのか、CakePHP3の動向などを話しますので、ぜひこちらにも参加ください。</p>

<h3>お知らせと感謝（追記）</h3>

<p>CakePHP3の話題もあるなか、まだまだ現場ではCakePHP2を利用するケースもあると思います。
本書をきっかけにCakePHPをより学んでみたいなと思っていただけたら、私も共著者で参加したCakePHP2実践入門(<a href="http://www.amazon.co.jp/CakePHP2-%E5%AE%9F%E8%B7%B5%E5%85%A5%E9%96%80-WEB-PRESS-plus/dp/4774153249">amazonでチェック</a>)を参考文献として手に取ってみてください。</p>

<p>こちらはちょうど2年ほど前の2012/09/29に発刊となったのですが、このたび <code>第3刷</code> の増刷が決まりました。</p>

<p>長い間CakePHP2の参考書として手に取っていただいているようで、本当に嬉しいです。ありがとうございます。</p>



    <div class="row">
      <div class="small-12 medium-5 large-5 small-centered columns blog-social">
        <ul class="social-buttons cf">
          <li>
            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="CakePHPで学ぶ継続的インテグレーションが発売されます" data-url="http://blog.open.tokyo.jp/2014/09/07/cakephp-ci-book.html" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
          </li>
          <li>
            <a href="http://www.facebook.com/sharer.php?u=http://blog.open.tokyo.jp/2014/09/07/cakephp-ci-book.html&t=CakePHP%E3%81%A7%E5%AD%A6%E3%81%B6%E7%B6%99%E7%B6%9A%E7%9A%84%E3%82%A4%E3%83%B3%E3%83%86%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%8C%E7%99%BA%E5%A3%B2%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99" class="socialite facebook-like" data-href="http://blog.open.tokyo.jp/2014/09/07/cakephp-ci-book.html" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
          </li>
        </ul>
      </div>
      <div class="clearfix"></div>
    </div>

  </div>
  <h2 class="title"><a href="/2014/08/17/cakephp2-plugin-travis.html">CakePHP2のプラグインをTravis.ciで継続的インテグレーションする</a></h2>
  <p class="postdate"><a href="/2014/08/17.html" title="Permanent link">Sunday, August 17, 2014 04:00:00 PM</a></p>
  <p class="tags">
      <a href="/tags/php.html" rel="tag">PHP</a>
      <a href="/tags/cakephp.html" rel="tag">CakePHP</a>
      <a href="/tags/%E7%B6%99%E7%B6%9A%E7%9A%84%E3%82%A4%E3%83%B3%E3%83%86%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3.html" rel="tag">継続的インテグレーション</a>
  </p>
  <div class="content">
    <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
    <p>春先ぐらいからBlogの更新が滞っていましたが、その要因となったアレが大分落ち着いてきたので、たまっていたネタを順番に書き出します。</p>

<p>CakePHP2のプラグインを作成／公開していて、継続的インテグレーションってどうするの？と思っていました。
もちろんユニットテスト書いてあるし、素晴らしい協力者の方がPull Requestを送ってくれれば、developブランチに取り込んでテストしたりします。</p>

<p>Githubを徘徊していると、よく見る</p>

<p><img src="/images/blog/cakephp2_plugin_ci_1.png" alt="" /></p>

<p>これを表示したいと思ったのです。</p>

<p>ただCakePHP2のプラグインは当然それだけではユニットテストを実行できません。CakePHPのアプリケーションがあって、テスト用データベースとその設定があって…、ぬーん。
早い話、テスト用のアプリケーション作って、そこからテスト実行すれば良いの？ということをずっと思っていました。</p>

<h3>CakePHPの有名プラグインはどうしているのだろう？</h3>

<p>と思い、最初にチェックしたのはCakeDC/searchプラグイン。
大抵のアプリケーションで使う、もっともメジャーなプラグインではないかと思います。
Searchプラグインにも、あのビルド成功やダウンロード数、バージョン番号の画像が表示されています。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_2.png" alt="" /></p>

<p><code>.travis.yml</code> ファイルがあるので、内容を確認してみます。
すると、</p>
<div class="highlight"><pre class="highlight yaml"><code><span class="na">before_script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">git clone https://github.com/burzum/travis.git --depth 1 ../travis</span>
  <span class="pi">-</span> <span class="s">../travis/before_script.sh</span>
  <span class="pi">-</span> <span class="s">if [ "$PHPCS" != 1 ]; then</span>
            <span class="s">echo "</span>
                <span class="s">require_once APP . DS . 'vendor' . DS . 'phpunit' . DS . 'phpunit' . DS . 'PHPUnit' . DS . 'Autoload.php';</span>
            <span class="s">" &gt;&gt; ../cakephp/app/Config/bootstrap.php;</span>
    <span class="s">fi</span>
</code></pre></div>
<p><code>https://github.com/burzum/travis.git</code>をcloneしてきて、何かやっているようです。</p>

<h3>CakePHPプラグインを簡単にTravis.ciで継続的インテグレーションできる</h3>

<p>早速、ページにアクセスしてみると、どうもそれはあの<code>FriendsOfCake</code>からForkされたもののようです。
<code>FriendsOfCake</code>の<a href="https://github.com/FriendsOfCake/travis">元リポジトリ</a>を確認します。</p>

<blockquote>
<p>Easy travis setup for CakePHP plugins
This repository helps easy travis integration for CakePHP plugins, primarily focused on FriendsOfCake projects, but can be used within any plugin when satisfying the requirements.</p>
</blockquote>

<p>おぉ、正に私の求めていたもの。</p>

<h4>Fabricateに導入してみた</h4>

<p>最近作った中で、最も思い入れのあるCakePHPプラグイン<code>Fabricate</code>を継続的インテグレーションするため、上記の<code>FriendsOfCake/travis</code>を導入してみます。</p>

<p><code>Quick Install</code>に書いてるとおり、以下の手順で進めます。</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nb">cd</span> ~/develop/fabricate

git clone https://github.com/FriendsOfCake/travis.git

<span class="nb">export </span><span class="nv">PLUGIN_NAME</span><span class="o">=</span><span class="s2">"Fabricate"</span>

travis/setup.sh

<span class="nb">rm</span> <span class="nt">-rf</span> travis
</code></pre></div>
<p>私がやったときはこの手順ではなかったのですが、最近変わったみたいです…
まぁ細かい事は気にせずですね。</p>

<p>実行すると、以下のファイルが自動生成されます。</p>

<ul>
<li>.travis.yml : Travis.ciで継続的インテグレーションを実行するための設定ファイル</li>
<li>Test/Case/AllFabricateTest.php : プラグインのユニットテストをすべて実行するテストスイート。すでにこの命名規則で生成されていれば作られません。</li>
</ul>

<p>以前のバージョンでは</p>

<ul>
<li><code>.editorconfig</code></li>
<li><code>.semver</code></li>
<li><code>.travis.yml</code></li>
<li><code>.AllPluginNameTest.php</code></li>
<li><code>composer.json</code></li>
<li><code>CONTRIBUTING.markdown</code></li>
<li><code>LICENSE.txt</code></li>
<li><code>README.markdown</code></li>
</ul>

<p>が生成されていましたが、継続的インテグレーションには必要がないファイルも混在していたので、整理されたものと思います。</p>

<p>後はTravis.ciにサインアップして、リポジトリを追加するだけです。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_3.png" alt="" /></p>

<p>実は、これが最初のビルド。<code>PLUGIN_NAME</code>をexportしていなかったので、正しくテストの実行が動いていませんでした。<code>PLUGIN_NAME</code>はちゃんとexportするようにした方が良いです。
.travis.ymlの<code>PLUGIN_NAME</code>を<code>Fabricate</code>に設定して実行した結果が以下の画面です。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_4.png" alt="" /></p>

<p>現在のtravis.gitではPHP5.4以上のようなので、問題ないのですが、当時（と言っても数ヶ月前）はPHP5.3もテスト対象になっていたので、ショートArrayシンタックスを使っている私のコードはテストが失敗していました。.travis,ymlのPHP部分を以下のように変更して</p>
<div class="highlight"><pre class="highlight yaml"><code><span class="na">php</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="m">5.4</span>
  <span class="pi">-</span> <span class="m">5.5</span>
</code></pre></div>
<p>pushすると、ビルド結果は以下のようになります。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_5.png" alt="" /></p>

<p>PHPCS以外は成功しています。</p>

<p>PHPCSではCakePHPのコード標準がチェックされます。
CakePHPの標準コードチェックだと厳しい部分だったり、パラメータを変更してチェックさせたくないディレクトリがあったりすると思うので、<code>PHPCS_ARGS</code>でphpcsを実行するときのパラメータを上書きできるようになっています。</p>
<div class="highlight"><pre class="highlight yaml"><code><span class="na">matrix</span><span class="pi">:</span>
  <span class="na">include</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">php</span><span class="pi">:</span> <span class="m">5.4</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">COVERALLS=1</span>
    <span class="pi">-</span> <span class="na">php</span><span class="pi">:</span> <span class="m">5.4</span>
      <span class="na">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">PHPCS=1</span>
        <span class="pi">-</span> <span class="s">PHPCS_ARGS="-p -s --extensions=php --standard=ruleset.xml --ignore='*/Test/*,*/Vendor/*' ."</span>

</code></pre></div>
<p>拡張子phpのファイルを対象とし、TestやVendorのディレクトリを対象外として実行します。
ruleset.xmlは以下のようにしました。</p>
<div class="highlight"><pre class="highlight xml"><code><span class="nt">&lt;ruleset</span> <span class="na">name=</span><span class="s">"Custom Standard"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">ref=</span><span class="s">"CakePHP"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;exclude</span> <span class="na">name=</span><span class="s">"CakePHP.NamingConventions.ValidVariableName.PrivateNoUnderscore"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;exclude</span> <span class="na">name=</span><span class="s">"CakePHP.NamingConventions.ValidFunctionName.PrivateNoUnderscore"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;exclude</span> <span class="na">name=</span><span class="s">"CakePHP.NamingConventions.ValidVariableName.ProtectedNoUnderscore"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;exclude</span> <span class="na">name=</span><span class="s">"CakePHP.NamingConventions.ValidFunctionName.ProtectedNoUnderscore"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;exclude</span> <span class="na">name=</span><span class="s">"CakePHP.NamingConventions.ValidFunctionName.ScopeNotCamelCaps"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;exclude</span> <span class="na">name=</span><span class="s">"CakePHP.NamingConventions.ValidVariableName.MemberVarNotCamelCaps"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;exclude</span> <span class="na">name=</span><span class="s">"CakePHP.WhiteSpace.TabAndSpace"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/rule&gt;</span>
<span class="nt">&lt;/ruleset&gt;</span>

</code></pre></div>
<p>CakePHPのコード標準ではprivateやprotectedの変数、関数の先頭にアンダースコアが求められるので、それを無効にしたのと、キャメルケースではない変数や関数名を使いたい箇所があったので、それを無効にしています。
最後の<code>CakePHP.WhiteSpace.TabAndSpace</code>では、以下のように<code>=</code>のインデント位置を合わせたコードがエラーになってしまうので、無効にしています（わかりづらいですが、=の位置が揃っています）。</p>
<div class="highlight"><pre class="highlight php"><code><span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">name</span>  <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">items</span> <span class="o">=</span> <span class="p">[];</span>
<span class="p">}</span>
</code></pre></div>
<h3>どうなっているのか？</h3>

<p>プラグインのリポジトリには<code>.travis.yml</code>が追加されるぐらいです。
この設定内で、FriendsOfCakeのtravisリポジトリがcloneされ、以下に記述されている手順が実行されます。</p>
<div class="highlight"><pre class="highlight yaml"><code><span class="na">before_script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">git clone -b master https://github.com/FriendsOfCake/travis.git --depth 1 ../travis</span>
  <span class="pi">-</span> <span class="s">../travis/before_script.sh</span>

<span class="na">script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">../travis/script.sh</span>

<span class="na">after_success</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">../travis/after_success.sh</span>
</code></pre></div>
<p>実行されるパターンは.travis.ymlに記述されている<code>php</code>と<code>env-matrix</code>の組み合わせと、<code>matrix</code>のパターンになります。</p>

<ul>
<li>PHP5.4, DB=mysql CAKE_VERSION=2.4</li>
<li>PHP5,4, DB=mysql CAKE_VERSION=2.5</li>
<li>PHP5.5, DB=mysql CAKE_VERSION=2.4</li>
<li>PHP5,5, DB=mysql CAKE_VERSION=2.5</li>
<li>PHP5.4, COVERALLS=1</li>
<li>PHP5.4, PHPCS=1</li>
</ul>

<p>この6パターン毎に、<code>before_script</code>、<code>script</code>、<code>after_success</code>が呼び出されます。</p>

<h4>事前準備</h4>

<p><code>before_script.sh</code>は実行準備のためのスクリプトで、PHPCSが1にセットされている場合は、以下のとおりpearチャンネルからCakePHPのコード標準とphpcsが依存関係としてインストールされます。</p>
<div class="highlight"><pre class="highlight shell"><code><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$PHPCS</span><span class="s2">"</span> <span class="o">=</span> <span class="s1">'1'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>pear channel-discover pear.cakephp.org
    pear <span class="nb">install</span> <span class="nt">--alldeps</span> cakephp/CakePHP_CodeSniffer
    phpenv rehash
    <span class="nb">exit </span>0
<span class="k">fi</span>
</code></pre></div>
<p>続いて、CakePHP本体が1つ親のディレクトリにインストールされます。Travis.ciではプラグインのリポジトリが最初にcloneされるのですが、結果として以下のようなディレクトリ構成となります。</p>

<ul>
<li>$HOME/sizuhiko/Fabricate : プラグイン本体</li>
<li>$HOME/sizuhiko/travis : FriendsOfCakeのtravis.gitクローン先</li>
<li>$HOME/sizuhiko/cakephp : CakePHP本体</li>
<li>$HOME/sizuhiko/cakephp/app/Plugin/$PLUGIN_NAME : プラグイン本体がコピーされる先</li>
</ul>

<p>上記ディレクトリ構成ができた後で、composer で依存関係を解決します。COVERALLS用のカバレッジレポートも生成されるようにファイルが準備されます。</p>

<h4>実行</h4>

<p><code>script.sh</code>がPHPCSが1の場合はphpcsを、それ以外の場合はユニットテストを実行します。</p>

<h4>実行が成功したら</h4>

<p><code>after_success.sh</code>がCOVERALLSのカバレッジレポートを生成します。</p>

<h3>そして現在</h3>

<p>最初のスクリーンショットがFabricateの現在の状態です。すべて成功しています。</p>

<p>最後にREADMEにバッジを表示させる方法を紹介します。</p>

<h4>Travis.ciのバッジを表示する</h4>

<p>Travis.ciの画面にアクセスして</p>

<p><img src="/images/blog/cakephp2_plugin_ci_6.png" alt="" /></p>

<p><code>build:failing</code>のように表示されている画像をクリックします。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_7.png" alt="" /></p>

<p>ブランチを選択して、表示形式からマークダウンを選択したら、表示内容をREADME.mdに貼り付けます。</p>

<h4>カバレッジのバッジを表示する</h4>

<p>カバレッジは<a href="https://coveralls.io/">COVERALLS</a>というサービスを使って表示します。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_8.png" alt="" /></p>

<p>サイトにアクセスして、サインアップはGithubのアカウントでできるの簡単です。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_9.png" alt="" /></p>

<p>サインアップ後に、上部のメニュー表示から<code>REPOS</code>を選択して、</p>

<p><img src="/images/blog/cakephp2_plugin_ci_10.png" alt="" /></p>

<p><code>ADD REPO</code>をクリックしてリポジトリを追加します。
その後、追加したリポジトリのページを表示します。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_11.png" alt="" /></p>

<p>今度は表示される画像ではなく、<code>GET BADGE URL</code>というボタンをクリックします。このあたりのUIは統一されると嬉しいですね&hellip;</p>

<p><img src="/images/blog/cakephp2_plugin_ci_12.png" alt="" /></p>

<p>いろいろな記述形式のコードが表示されるのでマークダウンのコードを選択してREADME.mdに貼り付けます。</p>

<h4>ダウンロード数、バージョンを表示する</h4>

<p>ここからはCIとは関係ないのですが、よく見るバッジであるダウンロード数とバージョン番号も表示してみたいと思います。</p>

<p><a href="https://poser.pugx.org">Badge Poser</a>というサイトにアクセスします。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_13.png" alt="" /></p>

<p>ダウンロード数やバージョン番号は、Packagistで表示されている情報を画像に変換するので、リポジトリがPackagistに登録されていることが条件となります。
<code>Show the markdown for your Badges</code>にダウンロード数を表示したいPackagistのパッケージ名を入力します。</p>

<p><img src="/images/blog/cakephp2_plugin_ci_14.png" alt="" /></p>

<p>表示形式からマークダウンを選択して、コードをREADME.mdに貼り付けます。</p>

<h3>最後に</h3>

<p>CakePHPのプラグインを継続的インテグレーションする方法は、実はとても簡単でした。
これを機に、まだプラグインを継続的インテグレーションしていない<code>そこのあなた</code>も、Travis.ciとCOVERALLSを使って継続的インテグレーションをしてみましょう。</p>



    <div class="row">
      <div class="small-12 medium-5 large-5 small-centered columns blog-social">
        <ul class="social-buttons cf">
          <li>
            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="CakePHP2のプラグインをTravis.ciで継続的インテグレーションする" data-url="http://blog.open.tokyo.jp/2014/08/17/cakephp2-plugin-travis.html" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
          </li>
          <li>
            <a href="http://www.facebook.com/sharer.php?u=http://blog.open.tokyo.jp/2014/08/17/cakephp2-plugin-travis.html&t=CakePHP2%E3%81%AE%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%82%92Travis.ci%E3%81%A7%E7%B6%99%E7%B6%9A%E7%9A%84%E3%82%A4%E3%83%B3%E3%83%86%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%99%E3%82%8B" class="socialite facebook-like" data-href="http://blog.open.tokyo.jp/2014/08/17/cakephp2-plugin-travis.html" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
          </li>
        </ul>
      </div>
      <div class="clearfix"></div>
    </div>

  </div>
  <h2 class="title"><a href="/2014/06/27/cake3-mokumoku-5.html">CakePHP3 もくもく会#5 に参加して Model の新機能を試してきた</a></h2>
  <p class="postdate"><a href="/2014/06/27.html" title="Permanent link">Friday, June 27, 2014 02:19:00 PM</a></p>
  <p class="tags">
      <a href="/tags/php.html" rel="tag">PHP</a>
      <a href="/tags/cakephp.html" rel="tag">CakePHP</a>
      <a href="/tags/co-edo.html" rel="tag">Co-Edo</a>
  </p>
  <div class="content">
    <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
    <p>2013/6/16(月) に <a href="http://www.coworking.tokyo.jp/">コワーキングスペース茅場町 Co-Edo（コエド）</a> で行われた「<a href="http://coedo-cakephp.doorkeeper.jp/events/12132">CakePHP3 もくもく会 #5</a>」に参加しました。</p>

<p>前回のイベントではBakeすることに成功したので、今回は大きく変更となったモデル周辺についてテストコードから把握してみる目標をたてました。</p>

<h3>環境構築する（前回との差分）</h3>

<p>3回目に参加した記事では</p>

<blockquote>
<p>環境構築でも利用した Friends Of Cake のリポジトリにはCakePHPのアプリケーションスケルトンを作成する app-template というリポジトリがあります。
すでにCakePHP3用のスケルトンも(cake3ブランチとして)用意されているので、GitHubのREADMEに書いてあるとおりのコマンドでCakePHPのアプリケーション環境を構築します。</p>
<div class="highlight"><pre class="highlight plaintext"><code>composer -sdev create-project friendsofcake/app-template app dev-cake3
</code></pre></div></blockquote>

<p>のように記述したのですが、その後devが上がったところでこちらのスケルトンは最新追従していなかったので、CakePHPの公式スケルトンを使っています。</p>
<div class="highlight"><pre class="highlight plaintext"><code>composer create-project -s dev cakephp/app dev-cake3
</code></pre></div>
<h3>CakePHP3におけるモデル</h3>

<p>CakePHP3では従来モデル（Model）と呼んでいたクラスはなくなり、テーブル（Table）とエンティティ（Entity）という2つのクラスに別れます。従来のモデルがテーブルに変更になりfindなどの責務を持っています。find結果は従来arrayで返却されてきたのですが、CakePHP3からはエンティティと呼ばれるオブジェクトで返却されます。
CakePHP1から2にかけてbasukeさんが作られた<a href="https://github.com/josegonzalez/cakephp-entity">CakeEntity</a>というプラグインがあります。このプラグインはCakePHP3の新しいモデルのベースになったものでもあり、利用したことがあればそれほど違和感なく移行できるのではないかと思います。</p>

<h3>Bakeされた結果を見てみる</h3>

<p>前回bakeコマンドで生成したモデル層のファイルを見てみると</p>

<p>App/Model/Table/PostsTable.php</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">App\Model\Table</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Cake\ORM\Table</span><span class="p">;</span>
<span class="kn">use</span> <span class="nc">Cake\Validation\Validator</span><span class="p">;</span>

<span class="cd">/**
 * Posts Model
 */</span>
<span class="kd">class</span> <span class="nc">PostsTable</span> <span class="kd">extends</span> <span class="nc">Table</span> <span class="p">{</span>

<span class="cd">/**
 * Initialize method
 *
 * @param array $config The configuration for the Table.
 * @return void
 */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">initialize</span><span class="p">(</span><span class="kt">array</span> <span class="nv">$config</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">table</span><span class="p">(</span><span class="s1">'posts'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">displayField</span><span class="p">(</span><span class="s1">'title'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">primaryKey</span><span class="p">([</span><span class="s1">'id'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">addBehavior</span><span class="p">(</span><span class="s1">'Timestamp'</span><span class="p">);</span>

    <span class="p">}</span>

<span class="cd">/**
 * Default validation rules.
 *
 * @param \Cake\Validation\Validator $validator
 * @return \Cake\Validation\Validator
 */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">validationDefault</span><span class="p">(</span><span class="kt">Validator</span> <span class="nv">$validator</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$validator</span>
            <span class="o">-&gt;</span><span class="nf">add</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'valid'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'rule'</span> <span class="o">=&gt;</span> <span class="s1">'numeric'</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">allowEmpty</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'create'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">allowEmpty</span><span class="p">(</span><span class="s1">'title'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">allowEmpty</span><span class="p">(</span><span class="s1">'body'</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>App/Model/Entity/Post.php</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
<span class="kn">namespace</span> <span class="nn">App\Model\Entity</span><span class="p">;</span>

<span class="kn">use</span> <span class="nc">Cake\ORM\Entity</span><span class="p">;</span>

<span class="cd">/**
 * Post Entity.
 */</span>
<span class="kd">class</span> <span class="nc">Post</span> <span class="kd">extends</span> <span class="nc">Entity</span> <span class="p">{</span>

<span class="cd">/**
 * Fields that can be mass assigned using newEntity() or patchEntity().
 *
 * @var array
 */</span>
    <span class="k">protected</span> <span class="nv">$_accessible</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
        <span class="s1">'body'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">];</span>

<span class="p">}</span>
</code></pre></div>
<p>のようになっています。</p>

<p>PostsTable::initialize()は従来publicプロパティとして定義していたテーブル名などの情報です。
validationDefault()は$validatesで定義していたバリデーション定義です。</p>

<p>Postクラスはエンティティで$<em>accesibleに利用可能なフィールド名を列挙します。これはRailsでattr</em>accessorを定義するとプロパティにアクセス可能になるのと同様の効果を持つようになると推測されますが、現時点では何も実装はされていないようです。</p>

<h3>コアのテストコード見てみる</h3>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testRewind</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">table</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">();</span>
        <span class="nv">$first</span> <span class="o">=</span> <span class="nv">$second</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$first</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$second</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div>
<p>とてもザックリしたところを切り抜きましたが、まぁそういうことです。
これを2系のコードで似せて書くと</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testRewind</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nc">Model</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'all'</span><span class="p">);</span>
        <span class="nv">$first</span> <span class="o">=</span> <span class="nv">$second</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$first</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$second</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

</code></pre></div>
<p>えっ！行数3の方が増えてないか？！とかいうツッコミはいらないですよ！！
なんか聞いている程変わってないですよね。</p>

<p>ではもう少し複雑な例を</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">testFindAllNoFieldsAndNoHydration</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$table</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Table</span><span class="p">([</span>
            <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="s1">'users'</span><span class="p">,</span>
            <span class="s1">'connection'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">connection</span><span class="p">,</span>
        <span class="p">]);</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$table</span>
            <span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'all'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">([</span><span class="s1">'id IN'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
            <span class="o">-&gt;</span><span class="nf">order</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">hydrate</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">toArray</span><span class="p">();</span>
        <span class="nv">$expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">'mariano'</span><span class="p">,</span>
                <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'$2a$10$u05j8FjsvLBNdfhBhc21LOuVMpzpabVXQ9OpC2wO3pSO0q6t7HHMO'</span><span class="p">,</span>
                <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Carbon</span><span class="p">(</span><span class="s1">'2007-03-17 01:16:23'</span><span class="p">),</span>
                <span class="s1">'updated'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Carbon</span><span class="p">(</span><span class="s1">'2007-03-17 01:18:31'</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="p">[</span>
                <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s1">'username'</span> <span class="o">=&gt;</span> <span class="s1">'nate'</span><span class="p">,</span>
                <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'$2a$10$u05j8FjsvLBNdfhBhc21LOuVMpzpabVXQ9OpC2wO3pSO0q6t7HHMO'</span><span class="p">,</span>
                <span class="s1">'created'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Carbon</span><span class="p">(</span><span class="s1">'2008-03-17 01:18:23'</span><span class="p">),</span>
                <span class="s1">'updated'</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Carbon</span><span class="p">(</span><span class="s1">'2008-03-17 01:20:31'</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="nv">$expected</span><span class="p">,</span> <span class="nv">$results</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div>
<p>どうもテーブルには findやwhere,orderなどのメソッドがあり、それをチェインさせてクエリを組み立てるようです。これも他のActiveRecord系の記述とほぼ変わらない形式になります。
hydrate(false)を指定するとエンティティでなく従来の配列形式で値を戻すことができるようになっています。
メソッドチェインの最後のtoArray()はエンティティを配列形式で取得するという意味ではありません。CakePHP3からはfindの戻りがイテレータになります（配列ではないので注意が必要）。なのでイテレータからすべて配列形式で取得するという意味になります。</p>

<p>ではいくつかそれ以外の例を見てみましょう。</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'all'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">select</span><span class="p">([</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">])</span>
            <span class="o">-&gt;</span><span class="nf">where</span><span class="p">([</span><span class="s1">'created &gt;='</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Carbon</span><span class="p">(</span><span class="s1">'2010-01-22 00:00'</span><span class="p">)])</span>
            <span class="o">-&gt;</span><span class="nf">hydrate</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">order</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
</code></pre></div>
<p>たとえば取得するカラムを絞り込むためにはselect()を利用するようです。従来はfieldsで指定していたカラム名の配列です。</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'list'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'fields'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">]])</span>
            <span class="o">-&gt;</span><span class="nf">hydrate</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">order</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
</code></pre></div>
<p>とはいえ、従来っぽい書き方もできるようです。</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
        <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$table</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'all'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'threaded'</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="nf">select</span><span class="p">([</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'parent_id'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">])</span>
</code></pre></div>
<p>！！！！
findがチェインの中で2回呼ばれています。</p>

<h3>これがCakePHP3のモデルだ！</h3>

<p>findが2回とはどういうことなのか、ソースを調べてみました。
まずTable::find()とは何者なのか</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">find</span><span class="p">(</span><span class="nv">$type</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">,</span> <span class="nv">$options</span> <span class="o">=</span> <span class="p">[])</span> <span class="p">{</span>
        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">query</span><span class="p">();</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">select</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">callFinder</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$query</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>どうもクエリオブジェクトを取得して、それにselect()をかけて….. callFinder って何ですか？を返すみたいです。</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">callFinder</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="kt">Query</span> <span class="nv">$query</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$options</span> <span class="o">=</span> <span class="p">[])</span> <span class="p">{</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">applyOptions</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
        <span class="nv">$options</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">getOptions</span><span class="p">();</span>
        <span class="nv">$finder</span> <span class="o">=</span> <span class="s1">'find'</span> <span class="mf">.</span> <span class="nb">ucfirst</span><span class="p">(</span><span class="nv">$type</span><span class="p">);</span>          <span class="c1">// ココ</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">method_exists</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="nv">$finder</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">// とココに注目</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="p">{</span><span class="nv">$finder</span><span class="p">}(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_behaviors</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_behaviors</span><span class="o">-&gt;</span><span class="nf">hasFinder</span><span class="p">(</span><span class="nv">$type</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">_behaviors</span><span class="o">-&gt;</span><span class="nf">callFinder</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="p">[</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$options</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="err">\</span><span class="nf">BadMethodCallException</span><span class="p">(</span>
            <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'Unknown finder method "%s"'</span><span class="p">,</span> <span class="nv">$type</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>
<p>find(&lsquo;all&rsquo;) と呼ぶと<code>findAll</code>メソッドがあるかどうか（ビヘイビアも含めて）調べて、なければ例外になる。
ということはTableにfindAllとかあるの？</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">findAll</span><span class="p">(</span><span class="kt">Query</span> <span class="nv">$query</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div>
<p>あるよ！</p>

<p>そういうことか、これがCakePHP3のモデルか。</p>

<ul>
<li>条件やら何やらメソッドチェインである</li>
<li>旧来の配列形式に変換できる</li>
<li>findXxxで独自の条件などをメソッドチェインに組み込める（今ココ）</li>
</ul>

<h3>独自の条件をメソッドチェインに組み込む</h3>

<p>まずPostsテーブルにfindOrderIdDescというIDの降順で検索するメソッドを作成します。</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">findOrderIdDesc</span><span class="p">(</span><span class="kt">Query</span> <span class="nv">$query</span><span class="p">,</span> <span class="kt">array</span> <span class="nv">$options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="nf">order</span><span class="p">([</span><span class="s1">'id'</span><span class="o">=&gt;</span><span class="s1">'desc'</span><span class="p">]);</span>
    <span class="p">}</span>
</code></pre></div>
<p>でそれを使うときは</p>
<div class="highlight"><pre class="highlight php"><code><span class="cp">&lt;?php</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nc">Posts</span> <span class="o">=</span> <span class="nc">TableRegistry</span><span class="o">::</span><span class="nf">get</span><span class="p">(</span><span class="s1">'Posts'</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span> 
    <span class="nv">$posts</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="nc">Posts</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'all'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">find</span><span class="p">(</span><span class="s1">'orderIdDesc'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">all</span><span class="p">();</span>
</code></pre></div>
<p>みたいに書けるわけです。
もちろんいくつチェインしても良いです。
例えば様々なテーブルで利用できるファインダ（findXxxメソッド）をtraitで共通化するもの面白そうです。</p>

<p>このように新しいモデルはかなり期待の持てる作りにもなっています。
CakePHP3もAlphaになりました。
Alphaを使ってみての感想などはまた書きたいと思います</p>



    <div class="row">
      <div class="small-12 medium-5 large-5 small-centered columns blog-social">
        <ul class="social-buttons cf">
          <li>
            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="CakePHP3 もくもく会#5 に参加して Model の新機能を試してきた" data-url="http://blog.open.tokyo.jp/2014/06/27/cake3-mokumoku-5.html" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
          </li>
          <li>
            <a href="http://www.facebook.com/sharer.php?u=http://blog.open.tokyo.jp/2014/06/27/cake3-mokumoku-5.html&t=CakePHP3%20%E3%82%82%E3%81%8F%E3%82%82%E3%81%8F%E4%BC%9A%235%20%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%97%E3%81%A6%20Model%20%E3%81%AE%E6%96%B0%E6%A9%9F%E8%83%BD%E3%82%92%E8%A9%A6%E3%81%97%E3%81%A6%E3%81%8D%E3%81%9F" class="socialite facebook-like" data-href="http://blog.open.tokyo.jp/2014/06/27/cake3-mokumoku-5.html" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
          </li>
        </ul>
      </div>
      <div class="clearfix"></div>
    </div>

  </div>
  <h2 class="title"><a href="/2014/04/19/twfm-2014-04.html">Test the Web Forward Meetup (仮), Tokyo#2 に参加して Shadow DOM のテストを書いてきた</a></h2>
  <p class="postdate"><a href="/2014/04/19.html" title="Permanent link">Saturday, April 19, 2014 04:38:00 PM</a></p>
  <p class="tags">
      <a href="/tags/html5.html" rel="tag">HTML5</a>
      <a href="/tags/test.html" rel="tag">Test</a>
      <a href="/tags/shadow-dom.html" rel="tag">Shadow-DOM</a>
  </p>
  <div class="content">
    <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
    <p>html5jテスト部の活動「<a href="http://html5j-testing.doorkeeper.jp/events/10161">Test the Web Forward Meetup (仮), Tokyo#2</a>」に参加してきました。</p>

<p>当日は1回目の反省をふまえて以下の仕様について実施することとなっていました。</p>

<ul>
<li>HTMLのルビ（のパーサ周り）</li>
<li>CSS Text Decoration</li>
<li>Shadow DOM</li>
</ul>

<p>私は Shadow DOM を選択しました。理由はGoogle JapanのHayatoさんがSpecを書いているので、テストがマージされやすいんじゃないか？！という不純な動機と、仕様が難しいので参加者が少ないかな？という妄想からでした（ただ実際は一番人気でした！）。</p>

<p>そもそもこの活動は何なのか？というと、<code>みんなでHTML5やCSS、API仕様のテストケースを書こうというミートアップです</code>と書いてある通りです。
私たちWebに関わるデベロッパーであれば必ず利用するHTMLやCSS、ブラウザによって実装がマチマチでとか、IEがぁーとか言ってますよね。</p>

<p>なぜそうなるのか？</p>

<p>まずHTMLとかCSSはW3Cの仕様があってそれを各ブラウザベンダが実装するわけです（もちろん先に実装されているケースもあります）。ですが結果としてどのように見えるのか？という部分に関して言うと、特に<code>こうなるべき</code>という具体的な結果が書いてある訳ではありません。そうなると各ベンダは自分の実装は正しいと思ってリリースするのですが、それぞれバラバラだったという結果が起きるのです。
そのため、W3Cではテストの充実に力を入れているのですが、現時点ではリソース不足であったり、そもそもスペックの理解不足という自体が起こります。W3Cのスペックを読んだことがあると何となく想像できるかな、と思います。
そこでTest the Web Forwardという公式イベントや、今回のようなコミュニティ主導のミートアップでテストコードを充実させようという機会が増えてきています。</p>

<h3>テストの準備をする</h3>

<p><a href="http://testthewebforward.org/docs/github-101.html">Test the Web Forwardのドキュメント</a>を見れば、今時のWebデベロッパーであれば問題なく環境を構築することができます。
pythonのバージョンが2.7系だったり、<code>pip install html5lib</code> が必要なのに漏れていた（これについては今回のミートアップでPRが出されてマージされたはずです）り、ちょっと面倒なのですがまぁ問題ないでしょう。GitHub便利。そのうちVagrantファイルでも作ろうかなーと思っています。
ここまでは事前の準備としてやっておきました。</p>

<h3>当日やったこと</h3>

<p><a href="http://w3c.github.io/webcomponents/spec/shadow/">W3Cのスペック</a>を見ましょう。
当日はHayato Itoさんから仕様の説明を受けて進めるという流れだったのですが、それにしても仕様がむずい。
新しいテストケースはちょっと置いておき、既存のテストを流してみることにしました。すると１つエラーがあって、typoであることがわかったので<a href="https://github.com/w3c/web-platform-tests/pull/861">Pull Request</a>。これはすぐ取り込まれました。嬉しい！W3Cへの貢献ですよ！！</p>

<p>続けて Fail しているテストについて、スペシャリストの方に確認して修正方針を聞いたりして、テストを黙々と書いていきます。
1日作業でしたが、2つのテスト失敗を修正してタイムアップ。</p>

<h3>テストのやり方</h3>

<p>テストには</p>

<ul>
<li>refテスト
期待値:新しい仕様で書いたものと同じになるように既存の仕様で書いたもの、実際:新しい仕様で書いたもの、をスクリーンショットで比較する<br></li>
<li>domテスト
testharness.js という xUnit ベースのテスティングフレームワークが使える</li>
</ul>

<p>2通りのやり方があって、Shadow DOMはtestharness.jsでDOMのテストをする段階でした。
testharness.jsはxUnit系なんですが、equals(:actual, :expected) の記法になっていて、キモい！という話をしたら、開発者がmozilla系の方でfire方面ではそういう記述になっているという話を（FireFoxのcontributorの方から）伺うことができました。
これもミートアップでこその体験です。</p>

<p>モダンなテストの書き方という意味では、サーバサイドスクリプトとか今時のJavaScriptのテスティングフレームワークの方がイケてる感じにできますが、これも歴史的な背景（DOMの細かい評価をするのにtestharness.jsが最適であるという理由）ということです。今後についてはわからないけど、各ブラウザベンダなどがテストするときに利用しているということで変更（例えばJasmineに変えるとか）には高い壁があるのかもしれないです。</p>

<h3>最後に</h3>

<p>W3Cの活動に貢献する作業は今後も続けて行きたいので、ミートアップなくてもテストコードを書き続けて行きたいとおもいました。
ただmetaデータの書き方とかちょっと特殊なところもあったので、新しくやる場合は既存のテストコードをいくつか参照して、書き方のテンプレート部分を把握した方が良いと思いました。</p>

<p>それと今回はW3Cのテストスペシャリストとして Gérard Talbot 氏が初来日ということで基調講演を聴く事ができました。<a href="http://test.csswg.org/suites/css2.1/nightly-unstable/html4/vertical-align-117a.htm">2年間かかって作ったという最高傑作テストケース</a>を見てスペックのテストとは！を感じれたのも良かった。早速 Ahem フォントもインストールしました。</p>

<p>ミートアップ終了後は懇親会もあったのですが、体調不良のため最後までは持たずに帰宅いたしました&hellip;.</p>

<p>会場を提供いただいた Adobe さん（ノベルティまでいただき感謝！）、スポンサー各社様の協力でとても楽しいイベント（部活）でした。</p>



    <div class="row">
      <div class="small-12 medium-5 large-5 small-centered columns blog-social">
        <ul class="social-buttons cf">
          <li>
            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Test the Web Forward Meetup (仮), Tokyo#2 に参加して Shadow DOM のテストを書いてきた" data-url="http://blog.open.tokyo.jp/2014/04/19/twfm-2014-04.html" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
          </li>
          <li>
            <a href="http://www.facebook.com/sharer.php?u=http://blog.open.tokyo.jp/2014/04/19/twfm-2014-04.html&t=Test%20the%20Web%20Forward%20Meetup%20(%E4%BB%AE),%20Tokyo%232%20%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%97%E3%81%A6%20Shadow%20DOM%20%E3%81%AE%E3%83%86%E3%82%B9%E3%83%88%E3%82%92%E6%9B%B8%E3%81%84%E3%81%A6%E3%81%8D%E3%81%9F" class="socialite facebook-like" data-href="http://blog.open.tokyo.jp/2014/04/19/twfm-2014-04.html" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
          </li>
        </ul>
      </div>
      <div class="clearfix"></div>
    </div>

  </div>
  <h2 class="title"><a href="/2014/04/19/cake3-mokumoku-3.html">CakePHP3 もくもく会#3 に参加して Bake してきた</a></h2>
  <p class="postdate"><a href="/2014/04/19.html" title="Permanent link">Saturday, April 19, 2014 02:04:00 PM</a></p>
  <p class="tags">
      <a href="/tags/php.html" rel="tag">PHP</a>
      <a href="/tags/cakephp.html" rel="tag">CakePHP</a>
      <a href="/tags/co-edo.html" rel="tag">Co-Edo</a>
  </p>
  <div class="content">
    <!-- use article.summary(250) if you have Nokogiri available to show just
       the first 250 characters -->
    <p>2013/4/4(金) に <a href="http://www.coworking.tokyo.jp/">コワーキングスペース茅場町 Co-Edo（コエド）</a> で行われた「<a href="http://coedo-cakephp.doorkeeper.jp/events/10020">CakePHP3 もくもく会 #3</a>」に参加しました。</p>

<p>CakePHP3もdev preview2、せっかくの機会なので初Cake3を体験しようということです。</p>

<h3>環境構築する</h3>

<p>イベントページからリンクされていたCo-Edo謹製Vagrantを使っても良かったのですが、私はCakePHPのコアデベロッパも参加するコミュニティ <a href="http://friendsofcake.com/">Friends Of Cake</a> の <a href="https://github.com/FriendsOfCake/vagrant-chef">Vagrant Chef</a> を使いました。</p>

<p>事前に用意するものは</p>

<ul>
<li><a href="http://www.vagrantup.com/">Vagrant</a></li>
<li><a href="https://www.virtualbox.org/">Virtual Box</a></li>
</ul>

<p>です。概ね最新版で大丈夫でしょう。
ダウンロード＆インストールしたら、任意のディレクトリに先程のVagrant Chefをクローン（またはダウンロード）します。後は</p>
<div class="highlight"><pre class="highlight plaintext"><code>cd vagrant-chef
vagrant up
</code></pre></div>
<p>を実行してしばらく待ちましょう。Chefでインストールされるものは Vagrant Chef のREADMEに書いてあるので、そちらを参照してください。</p>
<div class="highlight"><pre class="highlight plaintext"><code>INFO: Chef Run complete in 541.542816 seconds
INFO: Running report handlers
INFO: Report handlers complete
</code></pre></div>
<p>なメッセージが出て、コンソールが戻ってきたらインストールの完了です。
動作確認として、http://192.168.13.37/ にアクセスしてみてください。</p>

<p><img src="/images/blog/cakephp3_vagrant_chef.png" alt="" /></p>

<p>デフォルト画面が出たら環境構築の完了です。</p>

<h3>CakePHP3をインストールする</h3>

<p>Vagrant ChefにはCakePHPをインストールするレシピも入っているのですが、Friends Of CakeにCakePHPの環境を作るスケルトンコマンドが別途用意されているので、レシピの編集は必要ないです。
生成したVagrant環境にログインします。</p>
<div class="highlight"><pre class="highlight plaintext"><code>vagrant ssh
</code></pre></div>
<p>ログイン直後</p>
<div class="highlight"><pre class="highlight plaintext"><code>vagrant@precise64:/vagrant$ ls -la
total 20
drwxr-xr-x  1 vagrant vagrant  306 Apr 19 05:37 .
drwxr-xr-x 25 root    root    4096 Apr 19 05:37 ..
drwxr-xr-x  1 vagrant vagrant  102 Apr 19 05:37 app
drwxr-xr-x  1 vagrant vagrant  510 Apr 19 05:30 cookbooks
drwxr-xr-x  1 vagrant vagrant  442 Apr 19 05:30 .git
-rw-r--r--  1 vagrant vagrant   12 Apr 19 05:30 .gitignore
-rw-r--r--  1 vagrant vagrant 5489 Apr 19 05:30 README.markdown
drwxr-xr-x  1 vagrant vagrant  102 Apr 19 05:31 .vagrant
-rw-r--r--  1 vagrant vagrant 1179 Apr 19 05:30 Vagrantfile
</code></pre></div>
<p>のようになっていて、すでにappディレクトリが存在します。ここには先程のデフォルト画面が入っているのですが、今回は新しくアプリを作成するのでappディレクトリは削除します。</p>
<div class="highlight"><pre class="highlight plaintext"><code>rm -rf app
</code></pre></div>
<p>環境構築でも利用した Friends Of Cake のリポジトリにはCakePHPのアプリケーションスケルトンを作成する app-template というリポジトリがあります。
すでにCakePHP3用のスケルトンも(cake3ブランチとして)用意されているので、GitHubのREADMEに書いてあるとおりのコマンドでCakePHPのアプリケーション環境を構築します。</p>
<div class="highlight"><pre class="highlight plaintext"><code>composer -sdev create-project friendsofcake/app-template app dev-cake3
</code></pre></div>
<p>app の部分がアプリケーション名です。Vagrant Chefを使った場合はappを指定してください。</p>
<div class="highlight"><pre class="highlight plaintext"><code>Do you want to remove the existing VCS (.git, .svn..) history? [Y,n]? 
</code></pre></div>
<p>最後に上記のような確認メッセージが出てくるので、履歴が気にならなければそのままEnterを押して終了します。
インストールの確認として、http://192.168.13.37/ にアクセスしてみてください。</p>

<p><img src="/images/blog/cakephp3_installed.png" alt="" /></p>

<p>おなじみのCakePHP画面が表示されます。tmpディレクトリが書き込みできないと警告されます。これはwebサーバのデフォルトuserがvagrantでなくwww-dataであるためですが、開発環境用なの気にせず</p>
<div class="highlight"><pre class="highlight plaintext"><code>sudo chmod -R 777 app/tmp
</code></pre></div>
<p>などのコマンドで権限を書き換えてください。</p>

<p><img src="/images/blog/cakephp3_tmp_ok.png" alt="" /></p>

<h3>データベースを設定する</h3>

<p>vagrant-chefを使うとデフォルトで database<em>name, test</em>database_name というデータベースが生成されています。
ただ文字コードの指定などの問題もあると思うので、ここは自分でデータベースを作成します。</p>
<div class="highlight"><pre class="highlight plaintext"><code>mysql -u root -p
</code></pre></div>
<p>vagrant-chefのMySQL rootパスワードは、vagrant-chefのREADMEを参照ください（現時点ではbananasです）。</p>
<div class="highlight"><pre class="highlight plaintext"><code>mysql&gt; CREATE DATABASE cake3_mokumoku CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
mysql&gt; CREATE DATABASE test_cake3_mokumoku CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;
</code></pre></div>
<p>続けておなじみのpostsテーブルを作成します。</p>
<div class="highlight"><pre class="highlight plaintext"><code>mysql&gt; use cake3_mokumoku;
mysql&gt; CREATE TABLE `posts` (
          `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
          `title` varchar(50) DEFAULT NULL,
          `body` text,
          `created` datetime DEFAULT NULL,
          `modified` datetime DEFAULT NULL,
          PRIMARY KEY (`id`)
        ) ENGINE=InnoDB  DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;
</code></pre></div>
<p>app-templateで作成したCakePHPアプリケーションは、<a href="https://github.com/josegonzalez/php-dotenv">php-dotenv</a>というライブラリを使って環境設定できるようになっています。
<code>app/App/Config/.env.default</code> ファイルをコピーして <code>app/App/Config/.env</code>ファイルを作成します。</p>
<div class="highlight"><pre class="highlight plaintext"><code>// app/App/Config/.env
export DATABASE_URL="mysql://my_app:secret@localhost/my_app?encoding=utf8"
export DATABASE_TEST_URL="mysql://my_app:secret@localhost/test_myapp?encoding=utf8"
</code></pre></div>
<p>の部分を</p>
<div class="highlight"><pre class="highlight plaintext"><code>// mysql://ユーザ名:パスワード@URL/データベース名
export CAKEDATABASE_URL="mysql://root:bananas@localhost/cake3_mokumoku?encoding=utf8"
export CAKEDATABASE_TEST_URL="mysql://root:bananas@localhost/test_cake3_mokumoku?encoding=utf8"
</code></pre></div>
<p>のように書き換えます。データベースの詳しい設定方法は <a href="https://github.com/AD7six/php-dsn">AD7six/php-dsn</a>を参照ください。
exportの名前を変更しているのは、nginxのfastcgiパラメータとしてvagrantインストール時に</p>
<div class="highlight"><pre class="highlight plaintext"><code>fastcgi_param DATABASE_URL          "mysql://root:&lt;%= node[:mysql][:server_root_password] %&gt;@localhost/database_name?encoding=utf8";
fastcgi_param DATABASE_TEST_URL     "mysql://root:&lt;%= node[:mysql][:server_root_password] %&gt;@localhost/test_database_name?encoding=utf8";
</code></pre></div>
<p>のような指定がされているため、設定値が重複してしまいfastcgi側が優先される仕組みとなっています。
このため異なる名前に変更しておきます。
合わせて、app.phpでDATABASE<em>URLを利用している箇所もCAKEDATABASE</em>URLに変更します。</p>
<div class="highlight"><pre class="highlight plaintext"><code>// app/Config/app.php#L211-
/**
 * Connection information used by the ORM to connect
 * to your application's datastores.
 */
    'Datasources' =&gt; [
        'default' =&gt; DbDsn::parse(env('CAKEDATABASE_URL')),

        /**
         * The test connection is used during the test suite.
         */
        'test' =&gt; DbDsn::parse(env('CAKEDATABASE_TEST_URL'))
    ],
</code></pre></div>
<h3>Cakeシェルを利用する</h3>

<p>コンソールから</p>
<div class="highlight"><pre class="highlight plaintext"><code>cd app/App
Console/cake -h
</code></pre></div>
<p>とヘルプを表示してみたいのですが、もし</p>
<div class="highlight"><pre class="highlight plaintext"><code>Exception: Shell class for "-working" could not be found. in [/vagrant/app/vendor/cakephp/cakephp/src/Console/ShellDispatcher.php, line 178]
</code></pre></div>
<p>というエラーが表示されたら、app/App/Console/cake を編集して</p>
<div class="highlight"><pre class="highlight plaintext"><code>exec php -q "$CONSOLE"/cake.php -working "$APP" "$@"
</code></pre></div>
<p>の行を</p>
<div class="highlight"><pre class="highlight plaintext"><code>exec php -q "$CONSOLE"/cake.php "$@"
</code></pre></div>
<p>のように変更してください。現時点では -working オプションがあるとうまく動作しないためです。
うまく動作した場合は</p>
<div class="highlight"><pre class="highlight shell"><code><span class="nv">$ </span>Console/cake <span class="nt">-h</span>

Welcome to CakePHP v3.0.0-dev2 Console
<span class="nt">---------------------------------------------------------------</span>
App : App
Path: /vagrant/app/App/
<span class="nt">---------------------------------------------------------------</span>
Current Paths:

<span class="k">*</span> app: App
<span class="k">*</span> root: /vagrant/app
<span class="k">*</span> core: /vagrant/app/vendor/cakephp/cakephp

Available Shells:

<span class="o">[</span>CORE] bake, i18n, server, <span class="nb">test</span>

<span class="o">[</span>app] console

To run an app or core <span class="nb">command</span>, <span class="nb">type </span>cake shell_name <span class="o">[</span>args]
To run a plugin <span class="nb">command</span>, <span class="nb">type </span>cake Plugin.shell_name <span class="o">[</span>args]
To get <span class="nb">help </span>on a specific <span class="nb">command</span>, <span class="nb">type </span>cake shell_name <span class="nt">--help</span>
</code></pre></div>
<p>のように表示されるはずです。</p>

<h3>Bakeする</h3>

<p>では早速Bakeしましょう</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ Console/cake bake model Posts

Welcome to CakePHP v3.0.0-dev2 Console
---------------------------------------------------------------
App : App
Path: /vagrant/app/App/
---------------------------------------------------------------
One moment while associations are detected.

Baking table class for Posts...

Creating file /vagrant/app/App/Model/Table/PostsTable.php
Wrote `/vagrant/app/App/Model/Table/PostsTable.php`

Baking entity class for Post...

Creating file /vagrant/app/App/Model/Entity/Post.php
Wrote `/vagrant/app/App/Model/Entity/Post.php`

Baking test fixture for Posts...

Creating file /vagrant/app/Test/Fixture/PostFixture.php
Wrote `/vagrant/app/Test/Fixture/PostFixture.php`

Baking test case for App\Model\Table\PostsTable ...

Creating file /vagrant/app/Test/TestCase/Model/Table/PostsTableTest.php
Wrote `/vagrant/app/Test/TestCase/Model/Table/PostsTableTest.php`
</code></pre></div>
<p>うまく動きます！！</p>

<p>続けてコントローラとビューも</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ Console/cake bake controller Posts
$ Console/cake bake view Posts
</code></pre></div>
<p>で生成します。</p>

<p>一通りbakeしたら、http://192.168.13.37/posts/ にアクセスしてみます。</p>

<p><img src="/images/blog/cakephp3_baked_posts.png" alt="" /></p>

<p>おなじみのBake画面が表示されます。追加、変更、削除などもうまく動作するようです（執筆時においては）。</p>

<p><img src="/images/blog/cakephp3_baked_saved.png" alt="" /></p>

<h3>最後に</h3>

<p>このブログはもくもく会から2週間ぐらい経過してしまいましたが、今回再度新しい環境を作って試しています。
もくもく会のときも同様の手順で進めていたのですが、いくらかbake周辺でコードの変更があったようで、うまく動いていた箇所が動かなくなっていたり、動かなかった箇所が動いていたりします。
開発者用のプレビュー2ということで、今後もコードは変わって行くと思いますが、Bakeが動く事で取り急ぎ動作するプログラムのベースは作れるようになっています。
実際にアプリケーションを作ってみてCakePHP3の新機能について感想を書いてみたり、要望を出してみたりすることも実リリースまでの期間としては大切なことだと思うので、今回簡単ではありますがブログとして公開してみました。</p>

<p>Co-Edo では今後も CakePHP3もくもく会が開かれると思うので、イベントページをチェックしておくと良いと思います。私も可能な範囲で参加していこうと思っています。</p>



    <div class="row">
      <div class="small-12 medium-5 large-5 small-centered columns blog-social">
        <ul class="social-buttons cf">
          <li>
            <a href="http://twitter.com/share" class="socialite twitter-share" data-text="CakePHP3 もくもく会#3 に参加して Bake してきた" data-url="http://blog.open.tokyo.jp/2014/04/19/cake3-mokumoku-3.html" data-count="vertical" rel="nofollow" target="_blank"><span class="vhidden">Share on Twitter</span></a>
          </li>
          <li>
            <a href="http://www.facebook.com/sharer.php?u=http://blog.open.tokyo.jp/2014/04/19/cake3-mokumoku-3.html&t=CakePHP3%20%E3%82%82%E3%81%8F%E3%82%82%E3%81%8F%E4%BC%9A%233%20%E3%81%AB%E5%8F%82%E5%8A%A0%E3%81%97%E3%81%A6%20Bake%20%E3%81%97%E3%81%A6%E3%81%8D%E3%81%9F" class="socialite facebook-like" data-href="http://blog.open.tokyo.jp/2014/04/19/cake3-mokumoku-3.html" data-send="false" data-layout="box_count" data-width="60" data-show-faces="false" rel="nofollow" target="_blank"><span class="vhidden">Share on Facebook</span></a>
          </li>
        </ul>
      </div>
      <div class="clearfix"></div>
    </div>

  </div>

  <p class="pagenav">
      <a href="/page/28/">« Prev</a>
        <a href="/page/25/">25</a>
        <a href="/page/26/">26</a>
        <a href="/page/27/">27</a>
        <a href="/page/28/">28</a>
        <b>29</b>
        <a href="/page/30/">30</a>
        <a href="/page/31/">31</a>
        <a href="/page/32/">32</a>
        <a href="/page/33/">33</a>
      <a href="/page/30/">Next »</a>
  </p>
<script type="text/javascript" src="/javascripts/image-resize-ie.js"></script>



        </div>
      </div>

      <div id="sidewrap">
        <div id="side">
          <div class="sidebox sidelinx">
            <h2>Recent Articles</h2>
            <div class="pad">
              <ul>
                  <li><a href="/2024/05/28/using-codecommit-codebuild-like-a-github-and-the-actions.html">CodecCmmit と CodeBuild を GitHub と Actions の組み合わせのように使う</a> <span>2024/05/28</span></li>
                  <li><a href="/2024/05/01/story-for-migrate-hobby-web-service-while-a-year-part-5.html">GAE gen1 で動いている PHP5.5 で作った個人開発サービスを gen2 PHP8.2 へ移行した1年記 〜 その 5</a> <span>2024/05/01</span></li>
                  <li><a href="/2024/04/30/story-for-migrate-hobby-web-service-while-a-year-part-4.html">GAE gen1 で動いている PHP5.5 で作った個人開発サービスを gen2 PHP8.2 へ移行した1年記 〜 その 4</a> <span>2024/04/30</span></li>
                  <li><a href="/2024/04/30/story-for-migrate-hobby-web-service-while-a-year-part-3.html">GAE gen1 で動いている PHP5.5 で作った個人開発サービスを gen2 PHP8.2 へ移行した1年記 〜 その 3</a> <span>2024/04/30</span></li>
                  <li><a href="/2024/03/20/story-for-migrate-hobby-web-service-while-a-year-part-2.html">GAE gen1 で動いている PHP5.5 で作った個人開発サービスを gen2 PHP8.2 へ移行した1年記 〜 その 2</a> <span>2024/03/20</span></li>
                  <li><a href="/2024/03/20/story-for-migrate-hobby-web-service-while-a-year-part-1.html">GAE gen1 で動いている PHP5.5 で作った個人開発サービスを gen2 PHP8.2 へ移行した1年記 〜 その 1</a> <span>2024/03/20</span></li>
                  <li><a href="/2024/02/18/php-conference-kansai-2024.html">PHPカンファレンス関西2024に参加して、オフラインカンファレンスの盛り上がりを体験してきた</a> <span>2024/02/18</span></li>
                  <li><a href="/2023/09/27/converting-multiple-repos-into-a-monorepo.html">マルチプルレポをモノレポへコミットログを残しながら移行する</a> <span>2023/09/27</span></li>
                  <li><a href="/2023/05/02/tsyringe-with-typescript-5.html">tsyringe を TypeScript 5 で使う方法</a> <span>2023/05/02</span></li>
                  <li><a href="/2023/04/19/integration-test-using-localstack.html">LocalStack を使って aws-sdk の Integration Test を実行する</a> <span>2023/04/19</span></li>
              </ul>
            </div>
          </div>
          <div class="sidebox" id="tagcloud">
            <h2>Tags</h2>
            <div class="pad">
              <ul class="nobullets clearfix">
                    <li class="size1">
                      <a href="/tags/aws.html" rel="tag">AWS</a>
                    </li>
                    <li class="size5">
                      <a href="/tags/php.html" rel="tag">PHP</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/gae.html" rel="tag">GAE</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/toiletevolution.html" rel="tag">toiletevolution</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/phpkansai.html" rel="tag">phpkansai</a>
                    </li>
                    <li class="size2">
                      <a href="/tags/typescript.html" rel="tag">TypeScript</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/aws-sdk.html" rel="tag">aws-sdk</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/aws-sdk-v3.html" rel="tag">aws-sdk@v3</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/jest.html" rel="tag">Jest</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/javascript.html" rel="tag">JavaScript</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/import-maps.html" rel="tag">import maps</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/dependencies-management.html" rel="tag">Dependencies Management</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/dependabot.html" rel="tag">dependabot</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/gcp.html" rel="tag">GCP</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/asucon.html" rel="tag">asucon</a>
                    </li>
                    <li class="size3">
                      <a href="/tags/polymer.html" rel="tag">Polymer</a>
                    </li>
                    <li class="size3">
                      <a href="/tags/polymer-co-edo.html" rel="tag">Polymer.co-edo</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/chirimen.html" rel="tag">CHIRIMEN</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/iot.html" rel="tag">IoT</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/wot.html" rel="tag">WoT</a>
                    </li>
                    <li class="size4">
                      <a href="/tags/cakephp.html" rel="tag">CakePHP</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/cakefest.html" rel="tag">CakeFest</a>
                    </li>
                    <li class="size2">
                      <a href="/tags/webcomponents.html" rel="tag">WebComponents</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/toiletevolution.html" rel="tag">ToiletEvolution</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/web-components.html" rel="tag">Web Components</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/phpcon.html" rel="tag">PHPcon</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/cakephp3.html" rel="tag">CakePHP3</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/bdd.html" rel="tag">BDD</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/behat.html" rel="tag">Behat</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/fixture.html" rel="tag">fixture</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/test.html" rel="tag">Test</a>
                    </li>
                    <li class="size0">
                      <a href="/tags/phpmatsuri.html" rel="tag">phpmatsuri</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/coverflow.html" rel="tag">CoverFlow</a>
                    </li>
                    <li class="size1">
                      <a href="/tags/flex.html" rel="tag">Flex</a>
                    </li>
              </ul>
            </div>
          </div>
          <div class="sidebox sidelinx">
            <h2>By Year</h2>
            <div class="pad">
              <ul>
                  <li><a href="/2024.html">2024</a> (7)</li>
                  <li><a href="/2023.html">2023</a> (12)</li>
                  <li><a href="/2022.html">2022</a> (14)</li>
                  <li><a href="/2021.html">2021</a> (1)</li>
                  <li><a href="/2020.html">2020</a> (6)</li>
                  <li><a href="/2019.html">2019</a> (41)</li>
                  <li><a href="/2018.html">2018</a> (31)</li>
                  <li><a href="/2017.html">2017</a> (7)</li>
                  <li><a href="/2016.html">2016</a> (5)</li>
                  <li><a href="/2015.html">2015</a> (13)</li>
                  <li><a href="/2014.html">2014</a> (14)</li>
                  <li><a href="/2013.html">2013</a> (6)</li>
                  <li><a href="/2012.html">2012</a> (7)</li>
                  <li><a href="/2011.html">2011</a> (11)</li>
                  <li><a href="/2010.html">2010</a> (3)</li>
                  <li><a href="/2009.html">2009</a> (10)</li>
                  <li><a href="/2008.html">2008</a> (16)</li>
              </ul>
            </div>
          </div>
          <div class="sidebox sidelinx">
            <h2>Twitter</h2>
            <a class="twitter-timeline" href="https://twitter.com/sizuhiko" data-widget-id="442558418625114112">@sizuhiko からのツイート</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
          </div>
        </div>
      </div>

      <div id="footer">
        <div id="footer2">
          <div class="clear"></div>
        </div>
    </div>
  </body>
</html>
